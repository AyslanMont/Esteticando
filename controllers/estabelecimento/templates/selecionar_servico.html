{% extends "base.html" %}

{% block links %}
<link rel="stylesheet" href="{{ url_for('static', filename='styles/selecionar_servico.css') }}">
{% endblock %}

{% block content %}
<main class="container">
  <section class="estabelecimento-header">
    {% if imagem_base64 %}
    <img src="data:image/jpeg;base64,{{ imagem_base64 }}" alt="{{ est_nome }}" class="estabelecimento-logo">
    {% else %}
    <img src="{{ url_for('static', filename='imgs/default-establishment.jpg') }}" alt="Imagem padrão"
      class="estabelecimento-logo">
    {% endif %}

    <div class="estabelecimento-info">
      <h1>{{ est_nome }}</h1>
      {% if est_descricao %}
      <p class="estabelecimento-descricao">{{ est_descricao }}</p>
      {% endif %}
      <div class="rating d-flex align-items-center gap-1">

        {% for i in range(1, 6) %}
        {% if media_avaliacao >= i %}
        <i class="bi bi-star-fill text-warning"></i> {# estrela cheia #}
        {% elif media_avaliacao >= i - 0.5 %}
        <i class="bi bi-star-half text-warning"></i> {# meia estrela #}
        {% else %}
        <i class="bi bi-star text-warning"></i> {# estrela vazia #}
        {% endif %}
        {% endfor %}

        <span class="rating-text">
          {{ media_avaliacao }} ({{ qtd_avaliacoes }} avaliações)
        </span>
      </div>
      <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#modalListaAvaliacoes">
        Ver todas as avaliações
      </button>
      {% if is_dono %}
      <div class="acoes-dono">
        <a href="{{ url_for('servico.adicionar_servico', est_id=est_id) }}" class="btn-acao">Cadastrar Serviço</a>
        <a href="{{ url_for('estabelecimento.editar_estabelecimento')}}" class="btn-acao">Editar Estabelecimento</a>
        <a href="{{ url_for('servico.listar_funcionarios', est_id=est_id) }}" class="btn-acao">Cadastrar Funcionário</a>
        <a href="{{ url_for('estabelecimento.agendamentos')}}" class="btn-acao">agendamentos</a>

      </div>
      {% endif %}
    </div>
  </section>
  {% if servicos %}
  <section class="servicos-list">
    <h2>Serviços Disponíveis</h2>

    {% for servico in servicos %}
    <div class="servico-card">
      <div class="servico-info">
        <h3>{{ servico.ser_nome }}</h3>
        <p class="servico-preco">R$ {{ "%.2f"|format(servico.ser_preco) }}</p>
        <p class="servico-duracao">{{ servico.ser_duracao }} minutos</p>

      </div>
      <div class="servico-actions">
        <a href="{{ url_for('agendamento.agendar', est_id=est_id, ser_id=servico.ser_id) }}"
          class="btn-agendar">Agendar</a>
        <button class="btn btn-primary btn-avaliar" data-ser-id="{{ servico.ser_id }}" data-bs-toggle="modal"
          data-bs-target="#modalAvaliacao">
          Avaliar Serviço
        </button>

      </div>
    </div>
    {% endfor %}
  </section>
  <div class="modal fade" id="modalAvaliacao" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">

        <form id="formAvaliacao" method="POST" action="{{ url_for('avaliacao.cadastrar_avaliacao') }}">
          <div class="modal-header">
            <h5 class="modal-title">Avaliar Serviço</h5>
            <button class="btn-close" data-bs-dismiss="modal"></button>
          </div>

          <div class="modal-body">

            <input type="hidden" name="nota" id="notaSelecionada">
            <input type="hidden" name="ser_id" id="serIdInput">


            <label class="form-label">Nota:</label>
            <div id="stars" class="d-flex gap-1 fs-3" style="cursor: pointer;">
              <i class="star bi bi-star" data-value="1"></i>
              <i class="star bi bi-star" data-value="2"></i>
              <i class="star bi bi-star" data-value="3"></i>
              <i class="star bi bi-star" data-value="4"></i>
              <i class="star bi bi-star" data-value="5"></i>
            </div>

            <label class="form-label mt-3">Comentário (opcional):</label>
            <textarea name="comentario" class="form-control"></textarea>

          </div>

          <div class="modal-footer">
            <button class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            <button type="submit" class="btn btn-success">Enviar Avaliação</button>
          </div>

        </form>

      </div>
    </div>
  </div>
  {% endif %}
</main>
<div class="modal fade" id="modalListaAvaliacoes" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title">Avaliações do Estabelecimento</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        {% if lista_avaliacoes %}
          {% for a in lista_avaliacoes %}
            <div class="card mb-2 p-3">
              <h5>{{ a.cli_nome }} — {{ a.ser_nome }}</h5>

              <div class="text-warning">
                {% for i in range(a.ava_nota) %}
                  <i class="bi bi-star-fill"></i>
                {% endfor %}
              </div>

              {% if a.ava_comentario %}
                <p class="mt-2">{{ a.ava_comentario }}</p>
              {% else %}
                <small class="text-muted">Sem comentário</small>
              {% endif %}
            </div>
          {% endfor %}
        {% else %}
          <p class="text-muted">Nenhuma avaliação registrada ainda.</p>
        {% endif %}
      </div>

    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}

<!-- BOOTSTRAP JS (ESSENCIAL PARA MODAL FUNCIONAR) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
document.addEventListener("DOMContentLoaded", function () {

  /***********************
   * Helpers
   ***********************/
  function qs(sel, root=document) { return root.querySelector(sel); }
  function qsa(sel, root=document) { return Array.from(root.querySelectorAll(sel)); }

  /***********************
   * ESTRELAS
   ***********************/
  const starsContainer = qs("#stars");
  const stars = starsContainer ? qsa("#stars .star") : [];
  const notaInput = qs("#notaSelecionada");
  let selectedRating = 0;

  function highlightStars(value) {
    stars.forEach(star => {
      const starValue = parseInt(star.dataset.value, 10);
      if (starValue <= value) {
        star.classList.remove("bi-star");
        star.classList.add("bi-star-fill");
      } else {
        star.classList.add("bi-star");
        star.classList.remove("bi-star-fill");
      }
    });
  }

  if (stars.length) {
    stars.forEach(star => {
      star.addEventListener("mouseenter", () => highlightStars(parseInt(star.dataset.value,10)));
      star.addEventListener("click", () => {
        selectedRating = parseInt(star.dataset.value,10);
        notaInput.value = selectedRating;
        highlightStars(selectedRating);
      });
    });
    if (starsContainer) {
      starsContainer.addEventListener("mouseleave", () => highlightStars(selectedRating));
    }
  }

  /***********************
   * CAPTURA SER_ID (robusto)
   ***********************/
  // elemento hidden que será preenchido
  const serHidden = qs("#serIdInput");
  if (!serHidden) {
    console.warn("Elemento #serIdInput não encontrado no DOM.");
  }

  // delegação: pega o botão mesmo se clicar no <i>, <span> etc.
  document.addEventListener("click", function (e) {
    const btn = e.target.closest && e.target.closest(".btn-avaliar");
    if (!btn) return;
    const serId = btn.dataset.serId || btn.getAttribute("data-ser-id");
    console.log("DEBUG >>> capturado serId (delegation):", serId);
    if (serHidden) serHidden.value = serId ?? "";
  });

  /***********************
   * LOG DO FORM NO SUBMIT (para debug)
   * - NÃO REMOVER até confirmar que funciona
   ***********************/
  const form = qs("#formAvaliacao");
  if (form) {
    form.addEventListener("submit", function (ev) {

      const fd = new FormData(form);
      // monta string para console
      const entries = {};
      for (const [k,v] of fd.entries()) entries[k] = v;
      console.log("DEBUG >>> Form data antes do POST:", entries);
      fetch(form.action, { method: 'POST', body: fd, credentials: 'same-origin' })
        .then(r => { window.location.reload(); })
        .catch(err => console.error(err));
    });
  } else {
    console.warn("Form #formAvaliacao não encontrado.");
  }

});
</script>

{% endblock %}